version: '3.7'
services:
  http-proxy:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-webapp-node
    secrets:
      - source: webapp-cert
        target: /wcogtas.org.crt
      - source: webapp-key
        target: /wcogtas.org.key
  web-app:
    environment:
      JAVA_TOOL_OPTIONS: "-XX:+IgnoreUnrecognizedVMOptions -XX:+UseContainerSupport"
      JAVA_HOME: "/usr/local/gtas-java-jre"
      JAVA_OPTS: "-Xms4g -Xmx8g -XX:MaxPermSize=16g -Duser.timezone=UTC"
      EMAIL_SENDER_USERNAME: ""
      EMAIL_SENDER_PASSWORD: ""
      EMAIL_SENDER_HOST: ""
      SSL_TRUST_HOST: ""
      AUTOMATED_HIT_NOTIFICATION_EMAIL_ENABLED: "false"
      MANUAL_HIT_NOTIFICATION_EMAIL_ENABLED: "false"
      PROXY_IP: ""
    volumes:
      - type: bind
        source: /mnt/gtas-java-jre
        target: /usr/local/gtas-java-jre
      - type: bind
        source: /var/opt/gtas_web_app_application_properties
        target: /usr/local/tomcat/conf
    secrets:
      - source: webapp-cert
        target: /usr/local/tomcat/conf/wcogtas.org.crt
      - source: webapp-key
        target: /usr/local/tomcat/conf/wcogtas.org.key
      - source: elastic-cert
        target: /usr/local/tomcat/conf/elasticsearch-node1.crt
      - source: elastic-key
        target: /usr/local/tomcat/conf/elasticsearch-node1.key
      - source: elastic-ca
        target: /usr/local/tomcat/conf/elastic-ca.crt
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-webapp-node
  gtas-scheduler:
    environment:
      JAVA_TOOL_OPTIONS: "-XX:+IgnoreUnrecognizedVMOptions -XX:+UseContainerSupport"
      JAVA_HOME: "/usr/local/gtas-java-jre"
      JAVA_OPTS: "-Xms8000m -Xmx16000m -Duser.timezone=UTC -Djava.awt.headless=true -Djava.security.egd=file:/dev/./urandom"
      EMAIL_SENDER_USERNAME: ""
      EMAIL_SENDER_PASSWORD: ""
      EMAIL_SENDER_HOST: ""
      SSL_TRUST_HOST: ""
      AUTOMATED_HIT_NOTIFICATION_EMAIL_ENABLED: "false"
      MANUAL_HIT_NOTIFICATION_EMAIL_ENABLED: "false"
      PROXY_IP: ""
    volumes:
      - type: bind
        source: /mnt/gtas-java-jre
        target: /usr/local/gtas-java-jre
      - type: bind
        source: /var/opt/gtas_scheduler_application_properties
        target: /usr/local/tomcat/conf
      - type: bind
        source: /mnt
        target: /usr/local/gtas-data
        consistency: consistent
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-messenger-node
  activemq:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-neo4j-node
  mariadb:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-db-node
  kibana:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-elk-node
    secrets:
      - source: elastic-ca
        target: /etc/kibana/config/ca.crt
      - source: kibana-crt
        target: /etc/kibana/config/kibana.crt
      - source: kibana-key
        target: /etc/kibana/config/kibana.key
  elasticsearch:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-elk-node
    secrets:
      - source: elastic-ca
        target: /usr/share/elasticsearch/config/certs/elasticsearch/elastic-ca.crt
      - source: elastic-cert
        target: /usr/share/elasticsearch/config/certs/elasticsearch/elasticsearch-node1.crt
      - source: elastic-key
        target: /usr/share/elasticsearch/config/certs/elasticsearch/elasticsearch-node1.key
  logstash:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-elk-node
  elk-setup:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-elk-node
  neo4j:
    deploy:
      placement:
        constraints:
          - node.hostname == gtas-neo4j-node

networks:
  GTAS_webapp-network:
    driver: "overlay"
    attachable: true
secrets:
  elastic-key:
    file: ./gtas-parent/gtas-commons/certs/elasticsearch-node1.key
  elastic-ca:
    file: ./gtas-parent/gtas-commons/certs/elastic-ca.crt
  elastic-cert:
    file: ./gtas-parent/gtas-commons/cers/elasticsearch-node1.crt
  webapp-cert:
    file: ./gtas-parent/gtas-commons/certs/wcogtas.org.crt
  webapp-key:
    file: ./gtas-parent/gtas-commons/certs/wcogtas.org.key